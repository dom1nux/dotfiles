{{- /* Machine-specific configuration detection */ -}}
{{- $isMizuki := eq .chezmoi.hostname "Mizuki" -}}
{{- $isMizuho := eq .chezmoi.hostname "mizuho" -}}
{{- $isZero := eq .chezmoi.hostname "zero" -}}
{{- $isDev := or $isMizuki $isMizuho -}}
{{- $isDesktop := $isMizuho -}}
{{- $isWSL := $isMizuki -}}
{{- $isServer := $isZero -}}
{{- $useZinit := or $isMizuki $isMizuho -}}

# --- ZSH Configuration for {{ .chezmoi.hostname }} ---
# Generated by chezmoi - optimized for performance

# --- Core Setup ---
export PATH=$PATH:/home/dom1nux/.local/bin

# Source additional environment variables (if exists)
[[ -f "$HOME/.local/bin/env" ]] && . "$HOME/.local/bin/env"

# OpenCode binary path
export PATH=/home/dom1nux/.opencode/bin:$PATH

{{- if $isMizuki }}
export EDITOR="hx"
export SUDO_EDITOR="hx"
{{- else if $isMizuho }}
export EDITOR="helix"
export SUDO_EDITOR="helix"
export SSH_AUTH_SOCK=/home/dom1nux/.bitwarden-ssh-agent.sock
{{- end }}

{{- if $isDev }}
export BAT_THEME=ansi
{{- end }}

# --- History Configuration ---
HISTSIZE=5000
HISTFILE=~/.zsh_history
SAVEHIST=$HISTSIZE
HISTDUP=erase
setopt appendhistory sharehistory hist_ignore_space hist_ignore_all_dups hist_save_no_dups hist_ignore_dups hist_find_no_dups

# --- Keybindings ---
bindkey -e
bindkey '^p' history-search-backward
bindkey '^n' history-search-forward
bindkey '^[w' kill-region

# --- Completion Setup ---
# Add custom completion directory to fpath
fpath=(~/.config/zsh/completion $fpath)

{{- if $useZinit }}

# --- Zinit Plugin Manager ---
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [[ ! -d "$ZINIT_HOME" ]]; then
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi
source "${ZINIT_HOME}/zinit.zsh"

# Load plugins with turbo mode for better performance
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions
zinit light Aloxaf/fzf-tab

# Load snippets
zinit snippet OMZL::git.zsh
zinit snippet OMZP::sudo
zinit snippet OMZP::kubectl
zinit snippet OMZP::vscode
zinit snippet OMZP::command-not-found

# Completion system (optimized: only regenerate once per day)
autoload -Uz compinit
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

zinit cdreplay -q

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu no
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'
{{- end }}

# --- Tool Initialization ---
{{- if $isMizuki }}
# Homebrew (WSL)
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{- end }}

{{- if $isDev }}
# Oh-my-posh prompt
if command -v oh-my-posh &> /dev/null; then
    eval "$(oh-my-posh init zsh --config '~/.config/oh-my-posh/my_theme_rightprompt.toml')"
fi

# Mise (version manager)
if command -v mise &> /dev/null; then
    eval "$(mise activate zsh)"
fi

# FZF (fuzzy finder)
if command -v fzf &> /dev/null; then
    eval "$(fzf --zsh)"
fi

# Zoxide (smart cd)
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init --cmd cd zsh)"
fi
{{- else if $isServer }}
# Simple prompt for servers
PS1='%n@%m:%~$ '
{{- end }}

# --- Aliases: Common ---
alias cz='chezmoi'
alias ap='chezmoi -v apply'
alias grep='grep --color=always'
alias ip='ip -color=auto'
alias ll='ls -la'
alias cls='clear'
alias tf='terraform'

{{- if $isDev }}

# --- Aliases: Development ---
alias ls='eza --group-directories-first --icons=always'
alias lt='eza --tree --level=2 --long --icons --git'
alias lta='lt -a'
alias cat='bat -P --style plain'
alias ff="fzf --preview 'bat --style=numbers --color=always {}'"

alias lg='lazygit'
alias d='docker'
alias dc='docker compose'
alias dps='docker ps'
alias di='docker images'
alias k='kubectl'
alias r='rails'

alias g='git'
alias gcm='git commit -m'
alias gcam='git commit -a -m'
alias gcad='git commit -a --amend'
{{- end }}

{{- if $isWSL }}

# --- Aliases: WSL ---
alias explorer='explorer.exe'
{{- end }}

{{- if $isDesktop }}

# --- Aliases: Desktop ---
alias uefi='systemctl reboot --firmware-setup'
alias hx='helix'
alias yayf="yay -Slq | fzf --multi --preview 'yay -Sii {1}' --preview-window=down:75% | xargs -ro yay -S"
{{- end }}

{{- if $isServer }}

# --- Aliases: Server ---
alias df='df -h'
alias free='free -h'
alias top='htop'
alias ports='netstat -tuln'
alias services='systemctl list-units --type=service'
alias logs='journalctl -f'
{{- end }}

# --- Functions ---
{{- if $isDev }}

# Quick nvim launcher
n() { 
  if [ "$#" -eq 0 ]; then 
    nvim .
  else 
    nvim "$@"
  fi
}

# Docker exec helper
dexec() {
    docker exec -it "$1" "${2:-bash}"
}
{{- end }}

{{- if $isWSL }}

# Windows explorer integration
open() {
    if [ $# -eq 0 ]; then
        explorer.exe .
    else
        explorer.exe "$@"
    fi
}
{{- end }}

{{- if $isDesktop }}

# Load desktop-specific functions (media transcoding, disk operations, etc.)
[[ -f ~/.config/zsh/desktop_functions.zsh ]] && source ~/.config/zsh/desktop_functions.zsh
{{- end }}

# --- Performance: Compile ZSH files for faster loading ---
# Compile .zshrc for faster loading (recompiles only when modified)
if [[ ! -f ~/.zshrc.zwc ]] || [[ ~/.zshrc -nt ~/.zshrc.zwc ]]; then
    zcompile ~/.zshrc
fi

# Compile completion dump for faster loading
if [[ -f ~/.zcompdump ]] && [[ (! -f ~/.zcompdump.zwc) || (~/.zcompdump -nt ~/.zcompdump.zwc) ]]; then
    zcompile ~/.zcompdump
fi

# --- End of Configuration ---
