#!/usr/bin/env bash

{{ if and (eq .chezmoi.os "linux") (.chezmoi.osRelease.id | lower | contains "arch") -}}
echo "Starting Arch Linux package installation..."

# Install native CLI packages first
echo "#### Installing Arch native CLI packages... ####"
sudo pacman -Syu --needed {{ range .packages.arch.cli.pacman }} {{.}}{{ end }}

# Bootstrap yay-bin if not present
if ! command -v yay &> /dev/null; then
    echo "Bootstrapping yay-bin installation..."
    TMP_DIR=$(mktemp -d)
    git clone https://aur.archlinux.org/yay-bin.git "$TMP_DIR"
    cd "$TMP_DIR"
    makepkg -si --noconfirm
    cd "$HOME"
    rm -rf "$TMP_DIR"
    echo "yay-bin bootstrapped successfully"
fi

# Install AUR CLI packages if any - currently none defined
# {{ if .packages.arch.cli.aur }}
# echo "Installing AUR CLI packages..."
# yay -Syu --needed {{ range .packages.arch.cli.aur }} {{.}}{{ end }}
{{ end }}

{{ if and (and (eq .chezmoi.os "linux") (.chezmoi.osRelease.id | lower | contains "arch")) (not (.chezmoi.kernel.osrelease | lower | contains "wsl")) -}}
# Install native desktop packages if not in WSL
echo "#### Installing Arch native desktop packages...####"
sudo pacman -Syu --needed {{ range .packages.arch.desktop.pacman }} {{.}}{{ end }}

# Install AUR desktop packages if not in WSL
echo "#### Installing AUR desktop packages...####"
yay -Syu --needed {{ range .packages.arch.desktop.aur }} {{.}}{{ end }}

{{ end}}

echo "#### Package installation completed successfully! ####"
